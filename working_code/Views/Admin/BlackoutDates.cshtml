@model IEnumerable<MBTP.Models.BlackoutDate>
@using Microsoft.AspNetCore.Mvc.Rendering
@{
    ViewData["Title"] = "Manage Blackouts";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Show only PCIDs 2â€“5 in the dropdown
    var locations = (ViewBag.ProfitCenters as List<SelectListItem>)?
        .Where(l => int.TryParse(l.Value, out var id) && id >= 2 && id <= 5)
        .ToList()
        ?? new List<SelectListItem>();
}

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" crossorigin="anonymous" />
   <link rel="stylesheet" href="~/css/site.css" />
</head>

<style>
   .color { background-color: #b4dfff; padding: 20px; }
   .center {
       margin: auto; text-align: center; width: 80%; max-width: 800px;
       border: 3px solid #b4dfff; padding: 30px 20px; border-radius: 10px; background-color: #ffffff;
   }
   .pdfButton {
       background-color: #b4dfff; border: none; color: #000; padding: 10px 20px;
       font-size: 16px; margin: 4px 6px; cursor: pointer; border-radius: 5px;
   }
   .pdfButton:hover { background-color: #9cd4ff; }
   table { margin-top: 20px; }
</style>

<div class="color">
    <h1 style="text-align:center">Blackout Dates Management</h1>

    <!-- Add form -->
    <div class="center">
        <h3>Add New Blackout Date</h3>
        <form asp-controller="Admin" asp-action="AddBlackout" method="post" id="addBlackoutForm">
            <div class="form-group mb-3">
                <label asp-for="@(new MBTP.Models.BlackoutDate().PCID)">Operation</label>
                <select name="PCID" class="form-control" required>
                    <option value="">Select Operation</option>
                    @foreach (var location in locations)
                    {
                        <option value="@location.Value">@location.Text</option>
                    }
                </select>
            </div>

            <div class="form-group mb-3">
                <label asp-for="@(new MBTP.Models.BlackoutDate().StartDate)">Start Date</label>
                <input type="date" name="StartDate" class="form-control" required />
            </div>

            <div class="form-group mb-3">
                <label asp-for="@(new MBTP.Models.BlackoutDate().EndDate)">End Date</label>
                <input type="date" name="EndDate" class="form-control" required />
            </div>

            <div class="form-group mb-3">
                <label asp-for="@(new MBTP.Models.BlackoutDate().Reason)">Reason</label>
                <select name="Reason" class="form-control" required>
                    <option value="">Select Reason</option>
                    <option value="Holiday">Holiday</option>
                    <option value="Weather">Weather</option>
                    <option value="Staff Shortage">Staff Shortage</option>
                    <option value="Seasonal">Seasonal</option>
                    <option value="Occupancy">Occupancy</option>
                    <option value="Maintenance">Maintenance</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div>
                <button type="button" class="pdfButton" id="addStay">Add Blackout</button>
                <button type="button" class="pdfButton" id="addCancel">Cancel</button>
            </div>
        </form>
    </div>

    <!-- Existing list -->
    <div class="center" style="margin-top:30px;">
        <h3>Existing Blackouts</h3>
        @if (Model != null && Model.Any())
        {
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Profit Center</th>
                        <th>Start</th>
                        <th>End</th>
                        <th>Reason</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var b in Model)
                {
                    <tr>
                        <td>@b.ProfitCenterName</td>
                        <td>@b.StartDate.ToString("yyyy-MM-dd")</td>
                        <td>@b.EndDate.ToString("yyyy-MM-dd")</td>
                        <td>@b.Reason</td>
                        <td>
                            <form asp-action="DeleteBlackout" method="post" style="display:inline;">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@b.BlackoutID" />
                                <button type="submit" class="pdfButton" style="background-color:#ffb4b4;"
                                        onclick="return confirm('Delete this blackout?');">
                                    Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        }
        else
        {
            <p>No blackout dates set.</p>
        }
    </div>
</div>

@section Scripts {
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    $(function () {
        // Add & Add+Exit buttons
        $("#addStay, #addExit").on("click", function (event) {
            event.preventDefault();

            var $form = $("#addBlackoutForm");
            var formData = $form.serialize();
            var actionType = this.id;

            $.post("/Admin/AddBlackout", formData)
                .done(function () {
                    if (actionType === "addExit") {
                        window.location.href = '@Url.Action("Administration","Home")';
                    } else {
                        $form[0].reset();
                        location.reload();
                    }
                })
                .fail(function (xhr) {
                    // If your controller returns Conflict(...) with JSON { message: "..." }
                    var msg = (xhr.responseJSON && xhr.responseJSON.message) || "Error adding blackout.";
                    alert(msg);
                });
        });

        // Cancel
        $("#addCancel").on("click", function () {
            window.location.href = '@Url.Action("Administration","Home")';
        });
    });
</script>
}
