@using System.Text

@{
    ViewData["Title"] = "Populate Bookings";
    var selectedMonth = ViewBag.SelectedMonth as DateTime?;
    var daysInMonth = DateTime.DaysInMonth(selectedMonth.Value.Year, selectedMonth.Value.Month);
    var firstDayOfMonth = new DateTime(selectedMonth.Value.Year, selectedMonth.Value.Month, 1).DayOfWeek;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Daily Bookings Report</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://npmcdn.com/flatpickr@4.6.3/dist/plugins/monthSelect/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .calendar-day, .calendar-header {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: center;
        }
        .flatpickr-monthSelect-months {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        .flatpickr-monthSelect-month {
            flex: 1 0 21%;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .flatpickr-monthSelect-month:hover, .flatpickr-monthSelect-month.selected {
            border-color: #ccc;
        }
        .flatpickr-current-month {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 24px;
            font-weight: bold;
        }
        .spinner {
            font-size: 3rem;
        }
        .label-input-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
    <i class="fas fa-spinner fa-spin spinner"></i>
</div>

<h1>Populate Bookings</h1>

<form method="get" asp-action="PopulateBookings">
    <div class="navigation-container">
        <div class="label-input-container">
            <label for="monthPicker">Select Month:</label>
            <input type="text" id="monthPicker" name="month" value="@selectedMonth?.ToString("yyyy-MM-dd")">
        </div>
        <button type="submit" style="display: none;"></button>
    </div>
</form>

@if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
{
    <div class="alert alert-danger">@ViewBag.ErrorMessage</div>
}

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr@4.6.3/dist/plugins/monthSelect/index.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const loadingOverlay = document.getElementById('loadingOverlay');

    // Show loading overlay when form is submitted
    document.querySelector('form').addEventListener('submit', function() {
        sessionStorage.setItem('loading', 'true');
        loadingOverlay.style.display = 'flex';
    });

    // Set up the date picker with Flatpickr
    flatpickr("#monthPicker", {
        dateFormat: "Y-m",
        maxDate: "today",
        defaultDate: "@selectedMonth?.ToString("yyyy-MM-dd")",
        onChange: function(selectedDates, dateStr, instance) {
            var selectedDate = new Date(selectedDates[0]);
            var month = selectedDate.getMonth() + 1; // Months are zero-indexed
            var year = selectedDate.getFullYear();
            var newUrl = new URL(window.location.href);
            newUrl.searchParams.set("month", `${year}-${month < 10 ? '0' : ''}${month}-01`);
            sessionStorage.setItem('loading', 'true'); // Set loading state
            loadingOverlay.style.display = 'flex'; // Show loading overlay
            window.location.href = newUrl.toString();
        },
        plugins: [
            new monthSelectPlugin({
                shorthand: true,
                dateFormat: "Y-m",
                altFormat: "F Y"
            })
        ]
    });

    // Hide loading overlay when content is fully loaded
    window.addEventListener('load', function() {
        loadingOverlay.style.display = 'none';
        sessionStorage.removeItem('loading'); // Remove loading state
    });

    // Check session storage for loading state
    if (sessionStorage.getItem('loading') === 'true') {
        loadingOverlay.style.display = 'flex';
    }
});
</script>

</body>
</html>